---
title: "Flows Analysis"
author: "Dave Bosworth"
date: "4/7/2020"
output: 
  html_document: 
    code_folding: hide
    toc: yes
    toc_float:
      collapsed: no
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Import and Prepare Data

Load R packages necessary for this analysis:
```{r load packages, message = FALSE, warning = FALSE}
# Load packages
library(tidyverse)
library(scales)
library(DT)
library(openwaterhg)
```

```{r clean flow data, message = FALSE}
flows_inlet <- daily_flow_data_se %>% 
  # only include a subset of the data
  filter(LocType == "Inlet")

# Sum the CCSB Flows
ccsb_flow <- filter(flows_inlet, str_detect(StationName, "^CCSB"))

ccsb_flow_sum <- ccsb_flow %>%                      
  group_by(SamplingEvent, Year) %>% 
  summarize(Flow = sum(Flow)) %>% 
  ungroup() %>% 
  mutate(StationName = "CCSB")

# Add back the summed CCSB flows and prepare data for plots
flows_clean <- flows_inlet %>% 
  anti_join(ccsb_flow) %>% 
  bind_rows(ccsb_flow_sum) %>% 
  # rename some station names
  mutate(
    StationName = case_when(
      StationName == "Knights Landing Ridge Cut" ~ "KLRC",
      StationName == "Putah Creek at Mace Blvd" ~ "Putah Creek",
      StationName == "Sac River above the Sacramento Weir" ~ "Sacramento Weir",
      TRUE ~ StationName
    )
  ) %>% 
  # apply plot order
  conv_fact_samplingevent() %>% 
  conv_fact_inlet_names()

# Clean up
rm(ccsb_flow, ccsb_flow_sum, flows_inlet)
```


# Run Calculations

Calculate total inlet flows for each sampling event:
```{r calc total inlet flows, warning = FALSE}
flows_total <- flows_clean %>% 
  group_by(SamplingEvent) %>% 
  summarize(total_flow = sum(Flow))
```

Calculate the inlet flow percentages:
```{r calc perc inlet flows}
flows_clean_perc <- flows_clean %>% 
  left_join(flows_total, by = "SamplingEvent") %>% 
  mutate(percent_flow = signif(Flow/total_flow, 3)) %>% 
  select(-c(LocType:total_flow)) %>% 
  arrange(StationName, SamplingEvent)

flows_clean_perc_wide <- flows_clean_perc %>% 
  pivot_wider(
    names_from = StationName,
    values_from = percent_flow
  ) %>% 
  replace_na(list("Fremont Weir" = 0, "Sacramento Weir" = 0)) %>% 
  select(-Year)
```

Calculate summary statistics of flows for each inlet:
```{r calc summ stats inlet flows}
# Prepare flows_total df to add to flows_clean df to be able to summarize total flows
flows_total_clean <- flows_total %>% 
  mutate(
    StationName = "Total",
    StationName = factor(
      StationName,
      levels = c(
        "KLRC",
        "CCSB",
        "Putah Creek",
        "Sacramento Weir",
        "Fremont Weir",
        "Total"
      )
    )
  ) %>% 
  rename(Flow = total_flow) %>% 
  filter(str_detect(SamplingEvent, "17$"))

flows_clean_summ <- flows_clean %>%
  filter(Year == 2017) %>% 
  mutate(StationName = fct_expand(StationName, "Total")) %>% 
  bind_rows(flows_total_clean) %>% 
  summ_stat(Flow, StationName) %>% 
  mutate_at(vars(Mean:IQR), round)

# Clean up
rm(flows_total_clean)
```

Calculate summary statistics of inlet flow percentages:
```{r calc summ stats perc inlet flows}
flows_clean_perc_summ <- flows_clean_perc %>% 
  filter(Year == 2017) %>% 
  summ_stat(percent_flow, StationName) %>% 
  mutate_at(vars(Mean:IQR), signif, digits = 3)
```


# Plots and Summary Statistics

The summary statistics for the flows only include the sampling events conducted in 2017. The remaining plots and tables include all sampling events conducted throughout the study period (2014-2017).

## Flows

### Barplot

```{r flow barplot}
p <- flows_clean %>% 
  ggplot(aes(x = SamplingEvent, y = Flow, fill = StationName)) +
  geom_col() +
  xlab(NULL) +
  scale_y_continuous(
    name = "Daily Average Flow (cfs)",
    labels = label_comma()
  ) +
  add_inlet_color_pal("fill", "Inlet") +
  theme_owhg(x_axis_v = TRUE)

plotly::ggplotly(p)
```

### Table of Flows for each Inlet

```{r flows table, message = FALSE}
flows_clean %>% 
  # Sort dataframe
  arrange(StationName, SamplingEvent) %>% 
  # Convert to wide format
  pivot_wider(
    id_cols = SamplingEvent,
    names_from = StationName,
    values_from = Flow
  ) %>% 
  # Replace some NA values with zeros
  replace_na(list("Fremont Weir" = 0, "Sacramento Weir" = 0)) %>% 
  # Add total flows for each sampling event
  left_join(flows_total) %>% 
  rename(Total = total_flow) %>% 
  # Round all Flow values
  mutate_at(vars(KLRC:Total), round) %>% 
  # Convert to a datatable
  datatable(rownames = FALSE) %>% 
  formatRound(2:7, digits = 0)
```

### Summary Statistics for each Inlet

```{r summ stats flows}
flows_clean_summ %>% datatable(rownames = FALSE)
```


## Percent Flows

### Proportional Barplot
```{r prop flow barplot}
p <- flows_clean %>% 
  ggplot(aes(x = SamplingEvent, y = Flow, fill = StationName)) +
  geom_col(position = "fill") +
  xlab(NULL) +
  scale_y_continuous(
    name = "Percent of total Inlet flow",
    labels = label_percent()
  ) +
  add_inlet_color_pal("fill", "Inlet") +
  theme_owhg(x_axis_v = TRUE)

plotly::ggplotly(p)
```

### Table of Percent Flow for each Inlet

```{r perc flows table}
flows_clean_perc_wide %>% 
  datatable(rownames = FALSE) %>% 
  formatPercentage(2:6, digits = 1)
```

### Summary Statistics for each Inlet Percentage

```{r summ stats perc flow}
flows_clean_perc_summ %>% 
  datatable(rownames = FALSE) %>% 
  formatPercentage(3:10, digits = 1)
```


## Extra Analyses in Technical Appendix

```{r extra flow analysis in ta, message = FALSE}
inlet_flows <- daily_flow_data_all %>% 
  filter(
    Year != 2014,
    LocType == "Inlet"
  )

# Sum the CCSB Flows
ccsb_flow <- filter(inlet_flows, str_detect(StationName, "^CCSB"))

ccsb_flow_sum <- ccsb_flow %>%                      
  group_by(Date, Year) %>% 
  summarize(Flow = sum(Flow)) %>% 
  ungroup() %>% 
  mutate(StationName = "CCSB")

# Add back the summed CCSB flows
inlet_flows <- inlet_flows %>% 
  anti_join(ccsb_flow) %>% 
  bind_rows(ccsb_flow_sum)

# Clean up 
rm(ccsb_flow, ccsb_flow_sum)

inlet_flows_total <- inlet_flows %>% 
  group_by(Date) %>% 
  summarize(total_flow = sum(Flow))

inlet_flows_perc <- inlet_flows %>% 
  left_join(inlet_flows_total, by = "Date") %>% 
  mutate(perc_flow = Flow/total_flow * 100)

inlet_flows_perc_fw <- inlet_flows_perc %>% 
  filter(
    StationName == "Fremont Weir",
    Flow != 0
  ) %>%
  group_by(Year) %>% 
  summarize(avg_per_flow = round(mean(perc_flow)))

flows_clean_perc_wide_fw <- flows_clean_perc_wide %>% 
  rename(fremont = "Fremont Weir") %>% 
  filter(
    str_detect(SamplingEvent, "17$"),
    fremont != 0
  )

fremont17 <- flows_clean_perc_wide_fw %>% pull(fremont)
klrc17 <- flows_clean_perc_wide_fw %>% pull(KLRC)
ccsb17 <- flows_clean_perc_wide_fw %>% pull(CCSB)
```

The Fremont Weir was always the most dominant source of water to the Yolo Bypass when it was overtopping, contributing averages of `r inlet_flows_perc_fw %>% filter(Year == 2016) %>% pull(avg_per_flow)`% and `r inlet_flows_perc_fw %>% filter(Year == 2017) %>% pull(avg_per_flow)`% of the total daily inflow when it was spilling during the 2016 and 2017 floods, respectively (Figure 8).  Daily inflows for the eight sampling events when the Fremont Weir was overtopping in 2017 show a similar trend.  The Fremont Weir dominated water inflows to the Yolo Bypass ranging from `r round(min(fremont17) * 100)` to `r round(max(fremont17) * 100)`% of the total daily inflow during these eight sampling events (Figure 4).  KLRC and CCSB contributed `r round(min(klrc17) * 100)`-`r round(max(klrc17) * 100)`% and `r round(min(ccsb17) * 100)`-`r round(max(ccsb17) * 100)`% of the total daily inflow, respectively, during these same eight events.


