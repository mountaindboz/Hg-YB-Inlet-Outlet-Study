---
title: "Net Loads for the Yolo Bypass"
author: "Dave Bosworth"
date: "4/1/2020"
output: 
  html_document: 
    code_folding: hide
    toc: yes
    toc_float:
      collapsed: no
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Import and Prepare Data

Load R packages necessary for this analysis:
```{r load packages, message = FALSE, warning = FALSE}
# Load packages
library(tidyverse)
library(scales)
library(rlang)
library(openwaterhg)
library(DT)
```

Calculate total input and output loads for each sampling event and parameter:
```{r calc total loads}
total_loads <- loads_calc %>% 
  # Only include a subset of the data
  filter(str_detect(Analyte, "OC$|Hg|SS$")) %>%
  # Add an AnalyteGroup variable
  mutate(
    AnalyteGroup = case_when(
      str_detect(Analyte, "^MeHg") ~ "MeHg",
      str_detect(Analyte, "^THg") ~ "Hg",
      str_detect(Analyte, "OC$") ~ "OrgC",
      str_detect(Analyte, "SS$") ~ "SuspSolids"
    )
  ) %>% 
  # Group and sum load data
  group_by(SamplingEvent, Analyte, LoadUnits, AnalyteGroup, LocType) %>% 
  summarize(total_load = sum(Load)) %>% 
  ungroup() %>% 
  # Apply plot order
  conv_fact_samplingevent() %>% 
  mutate(LocType = factor(LocType, levels = c("Inlet", "Outlet", "Below Liberty")))
```

Calculate net loads for each reach (Upper, Liberty Island, Entire Bypass) grouped by sampling event and parameter:
```{r calc net loads}
net_loads <- total_loads %>% 
  pivot_wider(names_from = LocType, values_from = total_load) %>% 
  rename(below_liberty = "Below Liberty") %>% 
  # Calculate net loads for each reach
  mutate(
    Upper = Outlet - Inlet,
    Liberty = below_liberty - Outlet,
    Entire = below_liberty - Inlet
  ) %>% 
  select(-c(Inlet:below_liberty)) %>% 
  pivot_longer(
    cols = Upper:Entire,
    names_to = "Reach",
    values_to = "net_load"
  ) %>% 
  filter(!is.na(net_load)) %>% 
  # Apply plot order
  mutate(Reach = factor(Reach, levels = c("Upper", "Liberty", "Entire")))
```

Add total inlet flows to total_loads and net_loads dataframes:
```{r add flow data, message = FALSE}
# Prepare flow data df to join with loads df's
total_inflows <- daily_flow_data_se %>% 
  # Only include inlet flows
  filter(LocType == "Inlet") %>% 
  # Group by and sum flow data
  group_by(SamplingEvent) %>% 
  summarize(total_inflow = sum(Flow)) %>% 
  ungroup() %>% 
  # Apply plot order
  conv_fact_samplingevent()

# Join inlet flows to total_loads df
total_loads <- left_join(total_loads, total_inflows)

# Join inlet flows to net_loads df
net_loads <- left_join(net_loads, total_inflows)
```

Create two new dataframes with total and net loads only for 2017 sampling events. This will be used for the summary statistics and boxplots.
```{r filter 2017 data}
total_loads17 <- total_loads %>% filter(str_detect(SamplingEvent, "17$"))

net_loads17 <- net_loads %>% filter(str_detect(SamplingEvent, "17$"))
```


# Run Calculations

Calculate summary statistics of total loads:
```{r calc summ stats total loads}
total_loads_summ <- total_loads17 %>% 
  summ_stat(total_load, LocType, Analyte) %>% 
  mutate_at(vars(Mean:IQR), signif, digits = 3)
```

Calculate summary statistics of net loads:
```{r calc summ stats net loads}
net_loads_summ <- net_loads17 %>% 
  summ_stat(net_load, Reach, Analyte) %>% 
  mutate_at(vars(Mean:IQR), signif, digits = 3)
```


# Create Plot Functions

Function for barplots for total and net loads:
```{r fun barplot loads}
barplot_load <- function(df, y_var, fill_var, type = c("total", "net")) {
  # evaluate choices for type
  type <- match.arg(type, c("total", "net"))
  
  # convert variables to enquo
  y_var_enquo <- enquo(y_var)
  fill_var_enquo <- enquo(fill_var)
  
  # create plot
  p <- 
    ggplot(
      data = df,
      aes(
        x = SamplingEvent, 
        y = !!y_var_enquo, 
        fill = !!fill_var_enquo
      )
    ) +
    geom_col(position = "dodge") +
    facet_grid(
      rows= vars(Analyte),
      scales = "free"
    ) +
    add_gen_color_pal(3, "fill") +
    theme_owhg(x_axis_v = TRUE)
  
  # define y-axis labels based on type arg
  if (type == "total") {
    p <- p +
      labs(
        title = NULL,
        x = NULL,
        y = paste0("Total Loads (", df$LoadUnits[1], ")")
      )
  } else {
    p <- p +
      labs(
        title = NULL,
        x = NULL,
        y = paste0("Net Loads (", df$LoadUnits[1], ")")
      )
  }
  
  return(p)
}
```

Function for boxplots for total and net loads:
```{r fun boxplot loads}
boxplot_load <- function(df, x_var, y_var, type = c("total", "net")) {
  # evaluate choices for type
  type <- match.arg(type, c("total", "net"))
  
  # convert variables to enquo
  x_var_enquo <- enquo(x_var)
  y_var_enquo <- enquo(y_var)
  
  # create plot
  p <- 
    ggplot(
      data = df,
      aes(
        x = !!x_var_enquo,
        y = !!y_var_enquo
      )
    ) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(width = 0.25) +
    stat_summary( 
      fun = "mean", #add a symbol representing the mean of each group to the plot
      color = "red",
      geom = "point",
      shape = 9, #diamond cross shape
      size = 2 
    ) +
    facet_wrap(vars(Analyte)) +
    theme_owhg(x_axis_v = TRUE)
  
  # define title labels based on type arg
  if (type == "total") {
    p <- p +
      labs(
        title = paste0("Total Loads (", df$LoadUnits[1], ")"),
        x = NULL,
        y = NULL
      )
  } else {
    p <- p +
      labs(
        title = paste0("Net Loads (", df$LoadUnits[1], ")"),
        x = NULL,
        y = NULL
      )
  }
    
  return(p)
}
```

Function for total loads vs. total inflow scatterplots:
```{r fun total load vs inflow scatterplots}
scattplot_tload_flow <- function(df) {
  p <- 
    ggplot(
      data = df,
      aes(
        x = total_inflow, 
        y = total_load
      )
    ) +
    geom_point() +
    facet_grid(
      cols = vars(LocType),
      rows = vars(Analyte),
      scales = "free"
    ) +
    labs(
        title = NULL,
        x = "Total Inflow (cfs)",
        y = paste0("Total Load (", df$LoadUnits[1], ")")
    ) +
    scale_x_continuous(labels = label_comma()) +
    theme_owhg()
  
  return(p)
}
```


# Create Plots

Total Loads:
```{r create plots total loads, message = FALSE}
# All sampling events
total_loads_plots <- total_loads %>% 
  group_nest(AnalyteGroup) %>% 
  mutate(
    barplots = map(
      data,
      .f = barplot_load,
      y_var = total_load,
      fill_var = LocType,
      type = "total"
    ), 
    scatterplots = map(data, .f = scattplot_tload_flow)
  ) %>% 
  select(-data)

# Just 2017 sampling events
total_loads_boxplots <- total_loads17 %>% 
  group_nest(AnalyteGroup) %>% 
  mutate(
    boxplots = map(
      data,
      .f = boxplot_load,
      x_var = LocType,
      y_var = total_load,
      type = "total"
    )
  ) %>% 
  select(-data)

# Join two dataframes together
total_loads_plots <- left_join(total_loads_plots, total_loads_boxplots)

# Clean up 
rm(total_loads_boxplots)
```

Net Loads:
```{r create plots net loads, message = FALSE}
# All sampling events
net_loads_barplots <- net_loads %>% 
  group_nest(AnalyteGroup) %>% 
  mutate(
    barplots = map(
      data,
      .f = barplot_load,
      y_var = net_load,
      fill_var = Reach,
      type = "net"
    )
  ) %>% 
  select(-data)

# Just 2017 sampling events
net_loads_boxplots <- net_loads17 %>% 
  group_nest(AnalyteGroup) %>% 
  mutate(
    boxplots = map(
      data,
      .f = boxplot_load,
      x_var = Reach,
      y_var = net_load,
      type = "net"
    )
  ) %>% 
  select(-data)

# Join two dataframes together
net_loads_plots <- left_join(net_loads_barplots, net_loads_boxplots)

# Clean up
rm(net_loads_barplots, net_loads_boxplots)
```


# Plots and Summary Statistics

The summary statistics and boxplots for the total and net loads only include the sampling events conducted in 2017. The remaining plots include all sampling events conducted throughout the study period (2014-2017).

## MeHg

### Total Load Barplots

```{r mehg total load barplots, fig.height = 6}
total_loads_plots_mehg <- filter(total_loads_plots, AnalyteGroup == "MeHg")

total_loads_plots_mehg %>% pull(barplots) %>% chuck(1)
```

### Total Load Boxplots

Red diamond represents the average
```{r mehg total load boxplots, fig.height = 5.5}
p <- total_loads_plots_mehg %>% 
  pull(boxplots) %>% 
  chuck(1) %>% 
  plotly::plotly_build()

# Workaround to have plotly not add markers for outliers
p$x$data <- lapply(
  p$x$data, 
  FUN = function(x) {
    if (x$type == "box") {
      x$marker = list(opacity = 0)
    }
    return(x)
  }
)

p
```

### Total Load vs. Inflow Scatterplots

```{r mehg load vs flow plots, fig.height = 7, fig.width = 7}
total_loads_plots_mehg %>% pull(scatterplots) %>% chuck(1)
```

### Total Load Summary Statistics

```{r mehg total load summ stats}
total_loads_summ %>% 
  filter(str_detect(Analyte, "^MeHg")) %>% 
  datatable(rownames = FALSE)
```

### Net Load Barplots

```{r mehg net load barplots, fig.height = 6}
net_loads_plots_mehg <- filter(net_loads_plots, AnalyteGroup == "MeHg")

net_loads_plots_mehg %>% pull(barplots) %>% chuck(1)
```

### Net Load Boxplots

Red diamond represents the average
```{r mehg net load boxplots, fig.height = 5.5}
p <- net_loads_plots_mehg %>% 
  pull(boxplots) %>% 
  chuck(1) %>% 
  plotly::plotly_build()

# Workaround to have plotly not add markers for outliers
p$x$data <- lapply(
  p$x$data, 
  FUN = function(x) {
    if (x$type == "box") {
      x$marker = list(opacity = 0)
    }
    return(x)
  }
)

p
```

### Net Load Summary Statistics

```{r mehg net load summ stats}
net_loads_summ %>% 
  filter(str_detect(Analyte, "^MeHg")) %>% 
  datatable(rownames = FALSE)
```


## Hg

### Total Load Barplots

```{r hg total load barplots, fig.height = 6}
total_loads_plots_hg <- filter(total_loads_plots, AnalyteGroup == "Hg")

total_loads_plots_hg %>% pull(barplots) %>% chuck(1)
```

### Total Load Boxplots

Red diamond represents the average
```{r hg total load boxplots, fig.height = 5.5}
p <- total_loads_plots_hg %>% 
  pull(boxplots) %>% 
  chuck(1) %>% 
  plotly::plotly_build()

# Workaround to have plotly not add markers for outliers
p$x$data <- lapply(
  p$x$data, 
  FUN = function(x) {
    if (x$type == "box") {
      x$marker = list(opacity = 0)
    }
    return(x)
  }
)

p
```

### Total Load vs. Inflow Scatterplots

```{r hg load vs flow plots, fig.height = 7, fig.width = 7}
total_loads_plots_hg %>% pull(scatterplots) %>% chuck(1)
```

### Total Load Summary Statistics

```{r hg total load summ stats}
total_loads_summ %>% 
  filter(str_detect(Analyte, "^THg")) %>% 
  datatable(rownames = FALSE)
```

### Net Load Barplots

```{r hg net load barplots, fig.height = 6}
net_loads_plots_hg <- filter(net_loads_plots, AnalyteGroup == "Hg")

net_loads_plots_hg %>% pull(barplots) %>% chuck(1)
```

### Net Load Boxplots

Red diamond represents the average
```{r hg net load boxplots, fig.height = 5.5}
p <- net_loads_plots_hg %>% 
  pull(boxplots) %>% 
  chuck(1) %>% 
  plotly::plotly_build()

# Workaround to have plotly not add markers for outliers
p$x$data <- lapply(
  p$x$data, 
  FUN = function(x) {
    if (x$type == "box") {
      x$marker = list(opacity = 0)
    }
    return(x)
  }
)

p
```

### Net Load Summary Statistics

```{r hg net load summ stats}
net_loads_summ %>% 
  filter(str_detect(Analyte, "^THg")) %>% 
  datatable(rownames = FALSE)
```


## Organic Carbon

### Total Load Barplots

```{r oc total load barplots, fig.height = 6}
total_loads_plots_oc <- filter(total_loads_plots, AnalyteGroup == "OrgC")

total_loads_plots_oc %>% pull(barplots) %>% chuck(1)
```

### Total Load Boxplots

Red diamond represents the average
```{r oc total load boxplots, fig.height = 5.5}
p <- total_loads_plots_oc %>% 
  pull(boxplots) %>% 
  chuck(1) %>% 
  plotly::plotly_build()

# Workaround to have plotly not add markers for outliers
p$x$data <- lapply(
  p$x$data, 
  FUN = function(x) {
    if (x$type == "box") {
      x$marker = list(opacity = 0)
    }
    return(x)
  }
)

p
```

### Total Load vs. Inflow Scatterplots

```{r oc load vs flow plots, fig.height = 7, fig.width = 7}
total_loads_plots_oc %>% pull(scatterplots) %>% chuck(1)
```

### Total Load Summary Statistics

```{r oc total load summ stats}
total_loads_summ %>% 
  filter(str_detect(Analyte, "OC$")) %>% 
  datatable(rownames = FALSE)
```

### Net Load Barplots

```{r oc net load barplots, fig.height = 6}
net_loads_plots_oc <- filter(net_loads_plots, AnalyteGroup == "OrgC")

net_loads_plots_oc %>% pull(barplots) %>% chuck(1)
```

### Net Load Boxplots

Red diamond represents the average
```{r oc net load boxplots, fig.height = 5.5}
p <- net_loads_plots_oc %>% 
  pull(boxplots) %>% 
  chuck(1) %>% 
  plotly::plotly_build()

# Workaround to have plotly not add markers for outliers
p$x$data <- lapply(
  p$x$data, 
  FUN = function(x) {
    if (x$type == "box") {
      x$marker = list(opacity = 0)
    }
    return(x)
  }
)

p
```

### Net Load Summary Statistics

```{r oc net load summ stats}
net_loads_summ %>% 
  filter(str_detect(Analyte, "OC$")) %>% 
  datatable(rownames = FALSE)
```


## Suspended Solids

### Total Load Barplots

```{r ss total load barplots}
total_loads_plots_ss <- filter(total_loads_plots, AnalyteGroup == "SuspSolids")

total_loads_plots_ss %>% pull(barplots) %>% chuck(1)
```

### Total Load Boxplots

Red diamond represents the average
```{r ss total load boxplots, fig.height = 5.5}
p <- total_loads_plots_ss %>% 
  pull(boxplots) %>% 
  chuck(1) %>% 
  plotly::plotly_build()

# Workaround to have plotly not add markers for outliers
p$x$data <- lapply(
  p$x$data, 
  FUN = function(x) {
    if (x$type == "box") {
      x$marker = list(opacity = 0)
    }
    return(x)
  }
)

p
```

### Total Load vs. Inflow Scatterplots

```{r ss load vs flow plots}
total_loads_plots_ss %>% pull(scatterplots) %>% chuck(1)
```

### Total Load Summary Statistics

```{r ss total load summ stats}
total_loads_summ %>% 
  filter(str_detect(Analyte, "SS$")) %>% 
  datatable(rownames = FALSE)
```

### Net Load Barplots

```{r ss net load barplots}
net_loads_plots_ss <- filter(net_loads_plots, AnalyteGroup == "SuspSolids")

net_loads_plots_ss %>% pull(barplots) %>% chuck(1)
```

### Net Load Boxplots

Red diamond represents the average
```{r ss net load boxplots, fig.height = 5.5}
p <- net_loads_plots_ss %>% 
  pull(boxplots) %>% 
  chuck(1) %>% 
  plotly::plotly_build()

# Workaround to have plotly not add markers for outliers
p$x$data <- lapply(
  p$x$data, 
  FUN = function(x) {
    if (x$type == "box") {
      x$marker = list(opacity = 0)
    }
    return(x)
  }
)

p
```

### Net Load Summary Statistics

```{r ss net load summ stats}
net_loads_summ %>% 
  filter(str_detect(Analyte, "SS$")) %>% 
  datatable(rownames = FALSE)
```

