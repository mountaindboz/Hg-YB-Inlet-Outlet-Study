---
title: "Chapter 3 Calculations"
author: "Dave Bosworth"
date: "3/27/2020"
output: 
  html_document: 
    code_folding: hide
    toc: yes
    toc_float:
      collapsed: no
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Purpose

This document provides a second check on the calculations made in the Yolo Bypass Mass Balance section in Chapter 3 of the Open Water final report.

# Calculations

Load R packages necessary for this analysis:
```{r load packages, message = FALSE, warning = FALSE}
# Load packages
library(tidyverse)
library(openwaterhg)
library(knitr)
library(kableExtra)
library(gt)
```

## Water Balances section

Calculate percentage of each tributary's inflow to the total inflow. This is for the entire 2017 flood event from 1/9/2017 to 5/4/2017.
```{r per inflow}
# Bring in daily flow data for the inlets
source("YB_Mass_Balance/Flows/Import_Inlet_Flow_Data_all.R")

# Calculate the total inflow of each tributary for the entire 2017 flood event
flows_inlet_total_2017 <- flows_inlet_all %>% 
  filter(
    Date >= "2017-01-09",
    Date <= "2017-05-04"
  ) %>% 
  group_by(StationName) %>% 
  summarize(total_flow = sum(Flow)) %>% 
  arrange(StationName)

# Calculate the total inflow to the Bypass
total_inflow <- sum(flows_inlet_total_2017$total_flow)

# Calculate the percentage of each tributary's inflow to the total inflow
flows_inlet_perc_2017 <- flows_inlet_total_2017 %>% 
  mutate(perc_flow = round(total_flow/total_inflow, 2))

# Generate a gt table
gt(flows_inlet_perc_2017, rowname_col = "StationName") %>% 
  fmt_number(columns = vars(total_flow), decimals = 0) %>% 
  fmt_percent(columns = vars(perc_flow), decimals = 0) %>% 
  cols_label(
    total_flow = html("Total Flow<br>(cfs)"),
    perc_flow = html("Percentage of<br>total inflow")
  ) %>% 
  tab_header(
    title = "Inflow to the Yolo Bypass during the 2017 flood event",
    subtitle = "1/9/2017 to 5/4/2017"
  ) %>% 
  grand_summary_rows(
    columns = everything(), 
    fns = list("Total" = "sum"),
    drop_trailing_zeros = TRUE
  )
```

<br>
Same as in report, except for percentage for CCSB which is probably due to rounding. I would probably still use 5% for CCSB since the sum of the percentages in the table above is 101%.

***

Pull out the percentage for CCSB on March 15, 2017:
```{r per ccsb mar 15}
inlet_flow_mar15 <- flows_inlet_all %>% 
  filter(Date == "2017-03-15") %>% 
  arrange(StationName)

# Calculate total inflow for that day
total_flow_mar15 <- sum(inlet_flow_mar15$Flow)

# CCSB percentage
ccsb_per_flow_mar15 <- round(inlet_flow_mar15$Flow[1]/total_flow_mar15 * 100)
```
On the one occasion when the Fremont weir was not overtopping (March 15, 2017), the CCSB became the dominant source (`r ccsb_per_flow_mar15`%) of water into the Yolo Bypass

Same as in report.

```{r clean up flow data}
rm(list = ls())
```


## Tributary Input Loads section

Process input load data:
```{r process input load data, message = FALSE}
# Bring in load data for the inlets
source("YB_Mass_Balance/Loads/Import_Inlet_Load_Data.R")

# Filter just inlet loads for 2017
loads_inlet_2017 <- loads_inlet %>% 
  filter(Year == 2017) %>% 
  select(SamplingEvent, StationName, Analyte, Load, digits)
```

Calculate percentage of each tributary's input load to the total input load. This is for the all 9 sampling events during the 2017 flood event:
```{r per input loads, message = FALSE}
# Calculate total inlet loads of each parameter for each sampling event
total_inlet_loads <- loads_inlet_2017 %>% 
  group_by(SamplingEvent, Analyte) %>% 
  summarize(
    digits = min(digits, na.rm = TRUE),
    total_load = sum(Load)
  ) %>% 
  ungroup()

# Calculate percentage of total load for each tributary
inlet_loads_per <- loads_inlet_2017 %>% 
  select(-digits) %>% 
  left_join(total_inlet_loads) %>% 
  mutate(load_per = Load/total_load * 100) %>% 
  select(-digits)

# Calculate averages of the percentages across all sampling events in 2017
inlet_loads_per_avg <- inlet_loads_per %>% 
  group_by(StationName, Analyte) %>% 
  summarize(avg_load_per = round(mean(load_per))) %>% 
  ungroup()
 

# Pull out average percentages for Fremont Weir
fre_avg_per_load_uhg <- inlet_loads_per_avg %>%
  filter(
    StationName == "Fremont Weir",
    Analyte == "THg- total"
  ) %>% 
  pull(avg_load_per)

fre_avg_per_load_umehg <- inlet_loads_per_avg %>%
  filter(
    StationName == "Fremont Weir",
    Analyte == "MeHg- total"
  ) %>% 
  pull(avg_load_per)

fre_avg_per_load_tss <- inlet_loads_per_avg %>%
  filter(
    StationName == "Fremont Weir",
    Analyte == "TSS"
  ) %>% 
  pull(avg_load_per)
```
Fremont weir was the largest contributor of water to the Yolo Bypass and, on average, was the largest contributor of uHg (`r fre_avg_per_load_uhg`%), uMeHg (`r fre_avg_per_load_umehg`%), and TSS (`r fre_avg_per_load_tss`%) to the Yolo Bypass

Same as in the report.

***

Look at how Sacramento Weir ranks with other inputs when it was open.
```{r sac weir rank}
inlet_loads_per_sw <- inlet_loads_per %>% 
  # Convert SamplingEvent and StationName variables to factors
  conv_fact_samplingevent() %>% 
  conv_fact_inlet_names() %>% 
  # Filter out 4 events when the Sac Weir was open, and only include uHg, uMeHg and TSS
  filter(
    SamplingEvent %in% c(
      "Jan 11-12, 2017",
      "Jan 24-25, 2017",
      "Feb 14-15, 2017",
      "Mar 1-2, 2017"
    ),
    Analyte %in% c("THg- total", "MeHg- total", "TSS")
  ) %>% 
  # Convert load_per to decimal and round to 3 decimal places
  mutate(load_per = round(load_per/100, 3)) %>% 
  # Remove some variables
  select(-c(Load, total_load)) %>% 
  # Sort by SamplingEvent and StationName
  arrange(SamplingEvent, StationName) %>% 
  # Pivot the df wider
  pivot_wider(
    names_from = StationName,
    values_from = load_per
  )

# Generate a gt table
inlet_loads_per_sw %>% 
  group_by(Analyte) %>% 
  gt(rowname_col = "SamplingEvent") %>% 
  fmt_percent(columns = everything(), decimals = 1) %>% 
  cols_label(
    `Putah Creek` = html("Putah<br>Creek"),
    `Sacramento Weir` = html("Sacramento<br>Weir"),
    `Fremont Weir` = html("Fremont<br>Weir")
  ) %>% 
  tab_header(title = "Load percentages for each input")
```

<br>
Of the 4 events when the Sacramento weir was open, it was the second largest contributor of uMeHg for 3 events and of uHg and TSS for 2 events.

***

Check how the tributary contributions to input loads correspond to their contributions to input flow. Rank of 1 is the highest contributor, and 5 is the lowest. If there is good correspondence, most of the load and flow ranks would be the same. The following plot shows this information.
```{r loads vs flow ranks, message = FALSE, fig.width = 9, fig.height = 9}
# Bring in flow data for the inlets for the sampling events
source("YB_Mass_Balance/Flows/Import_Inlet_Flow_Data_SE.R")

# Filter just inlet flows for 2017
flows_inlet_se_2017 <- flows_inlet_se %>% 
  filter(Year == 2017) %>% 
  select(-c(Year, LocType))

# Rank flows for each sampling event
inlet_flow_se_rank <- flows_inlet_se_2017 %>% 
  filter(Flow != 0) %>% 
  group_by(SamplingEvent) %>% 
  mutate(flow_rank = rank(desc(Flow), ties.method = "average")) %>% 
  ungroup() %>% 
  select(-Flow)

# Rank loads for each sampling event and analyte
inlet_loads_rank <- loads_inlet_2017 %>% 
  select(-digits) %>% 
  # Remove added zeros for events when the weirs weren't spilling
  anti_join(zero_loads) %>% 
  group_by(SamplingEvent, Analyte) %>% 
  mutate(load_rank = rank(desc(Load), ties.method = "average")) %>% 
  ungroup() %>% 
  select(-Load)

# Join flow and load ranks together
inlet_flow_load_ranks <- left_join(inlet_loads_rank, inlet_flow_se_rank) %>% 
  # Only include parameters we are interested in
  filter(str_detect(Analyte, "^THg|^MeHg|OC$|TSS"))

# Apply plot order to analytes
analytes <- sort(unique(inlet_flow_load_ranks$Analyte))
analytes_order <- analytes[c(6:8,2:4,1,5,9,10)]
inlet_flow_load_ranks <- inlet_flow_load_ranks %>% 
  mutate(Analyte = factor(Analyte, levels = analytes_order))

# Plot ranks
inlet_flow_load_ranks %>% 
  ggplot(aes(x = flow_rank, y = load_rank)) +
  geom_count() +
  facet_wrap(
    vars(Analyte),
    ncol = 3
  ) +
  scale_size(breaks = seq(1, 9, by = 1)) +
  xlab("Flow Rank") +
  ylab("Load Rank") +
  scale_x_continuous(expand = expansion(mult = c(0.1, 0.1))) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.1)))
```

***

Check numbers in Table 3-2. Averages and Standard deviations:
```{r check table 3-2 avg and stdev, message = FALSE}
# Calculate averages and standard deviations of each input and analyte
inlet_loads_avg <- loads_inlet_2017 %>% 
  # only include uHg and uMeHg
  filter(Analyte %in% c("THg- total", "MeHg- total")) %>% 
  group_by(StationName, Analyte) %>% 
  summarize(
    sign_digits = min(digits, na.rm = TRUE),
    avg_load = signif(mean(Load), sign_digits),
    stdev = signif(sd(Load), sign_digits)
  ) %>% 
  ungroup()

# Calculate averages and standard deviations of total input for each analyte
total_inlet_loads_avg <- total_inlet_loads %>%
  # only include uHg and uMeHg
  filter(Analyte %in% c("THg- total", "MeHg- total")) %>% 
  group_by(Analyte) %>% 
  summarize(
    sign_digits = min(digits),
    avg_load = signif(mean(total_load), sign_digits),
    stdev = signif(sd(total_load), sign_digits)
  ) %>% 
  mutate(StationName = "Total")

# Bind total inlet loads to inlet loads df
inlet_loads_avg <- 
  bind_rows(inlet_loads_avg, total_inlet_loads_avg) %>% 
  select(-sign_digits)

# Restructure inlet_loads_avg df for gt table
avg_loads <- inlet_loads_avg %>% 
  pivot_wider(
    id_cols = StationName,
    names_from = Analyte,
    values_from = avg_load
  ) %>% 
  rename(
    MeHg_avg = "MeHg- total",
    THg_avg = "THg- total"
  )

sd_loads <- inlet_loads_avg %>% 
  pivot_wider(
    id_cols = StationName,
    names_from = Analyte,
    values_from = stdev
  ) %>% 
  rename(
    MeHg_sd = "MeHg- total",
    THg_sd = "THg- total"
  )

inlet_loads_avg_gt <- 
  left_join(avg_loads, sd_loads) %>% 
  mutate(
    StationName = factor(
      StationName, 
      levels = c(
        "Fremont Weir",
        "Sacramento Weir",
        "CCSB",
        "KLRC",
        "Putah Creek",
        "Total"
      )
    )
  ) %>% 
  arrange(StationName)

# Generate a gt table
inlet_loads_avg_gt %>% 
  gt(rowname_col = "StationName") %>% 
  fmt_number(
    columns = everything(),
    drop_trailing_zeros = TRUE
  ) %>% 
  cols_merge_uncert(
    col_val = vars(THg_avg),
    col_uncert = vars(THg_sd)
  ) %>%
  cols_merge_uncert(
    col_val = vars(MeHg_avg),
    col_uncert = vars(MeHg_sd)
  ) %>% 
  cols_move_to_end(vars(MeHg_avg)) %>% 
  cols_label(
    THg_avg = html("uHg Load<br>(g/day)"),
    MeHg_avg = html("uMeHg Load<br>(g/day)")
  ) %>% 
  tab_header(title = "Average uHg and uMeHg loads by tributary")
```

<br>
**Need to update numbers in Table 3-2 with the values in the table above.**
These are the final numbers rounded to the proper number of significant figures.

***
START HERE
Check numbers in Table 3-2. Percentages of the total load in the particulate fraction:
```{r check table 3-2 per particulate}
# Create df to be used to calculate percentages in the particulate fraction
inlet_loads_hg_frac <- loads_inlet_2017 %>% 
  filter(
    str_detect(Analyte, "^MeHg|^THg"),
    Load != 0
  ) %>% 
  separate(Analyte, into = c("Analyte", "Fraction"), sep = "- ") %>% 
  filter(Fraction != "filtered") %>% 
  pivot_wider(names_from = Fraction, values_from = Load)

# Calculate average percentages for each inlet
inlet_loads_part_avg <- inlet_loads_hg_frac %>% 
  mutate(per_part = particulate/total * 100) %>% 
  group_by(StationName, Analyte) %>% 
  summarize(avg_per_part = round(mean(per_part))) %>% 
  ungroup()

# Calculate average percentages for total inputs
inlet_loads_part_avg_total <- inlet_loads_hg_frac %>% 
  group_by(SamplingEvent, Analyte) %>% 
  summarize(
    part_sum = sum(particulate),
    total_sum = sum(total)
  ) %>% 
  ungroup() %>% 
  mutate(per_part = part_sum/total_sum * 100) %>% 
  group_by(Analyte) %>% 
  summarize(avg_per_part = round(mean(per_part))) %>% 
  ungroup() %>% 
  mutate(StationName = "Total")

# Bind df's together for kables
inlet_loads_part_avg <- bind_rows(inlet_loads_part_avg, inlet_loads_part_avg_total)

# Show a kable for each analyte
  # uHg
  inlet_loads_part_avg %>% 
    filter(Analyte == "THg") %>% 
    select(-Analyte) %>% 
    kable(caption = "Hg- Percent in the particulate fraction for each input") %>% 
    kable_styling("striped")
  
  # uMeHg
  inlet_loads_part_avg %>% 
    filter(Analyte == "MeHg") %>% 
    select(-Analyte) %>% 
    kable(caption = "MeHg- Percent in the particulate fraction for each input") %>% 
    kable_styling("striped")
```
A few differences in the inlet percentages probably due to rounding differences. 
**Total percentages were different than those in Table 3-2.** 

## Net Loads section

Check numbers in Table 3-3.
```{r check table 3-3}
# Sum input and output loads for each sampling event
total_loads <- loads_calc %>% 
  filter(
    Year == 2017,
    str_detect(Analyte, "^THg|^MeHg|OC$|TSS")
  ) %>% 
  group_by(SamplingEvent, Analyte, LocType) %>% 
  summarize(total_load = sum(Load)) %>% 
  ungroup()
  
# Calculate averages and stdev for input and output (Stairsteps) loads
total_loads_summ <- total_loads %>% 
  filter(LocType != "Below Liberty") %>% 
  group_by(Analyte, LocType) %>% 
  summarize(
    avg_load = signif(mean(total_load), 3),
    stdev_load = signif(sd(total_load), 3)  
  ) %>% 
  ungroup()

# Show a kable for each LocType
  # Input
  total_loads_summ %>% 
    filter(LocType == "Inlet") %>% 
    select(-LocType) %>% 
    kable(caption = "Input Loads- Average and Std Deviations") %>% 
    kable_styling("striped")
  
  # Output
  total_loads_summ %>% 
    filter(LocType == "Outlet") %>% 
    select(-LocType) %>% 
    kable(caption = "Output Loads- Average and Std Deviations") %>% 
    kable_styling("striped")

# Calculate averages and stdev for net loads
net_loads_summ <- total_loads %>% 
  pivot_wider(names_from = LocType, values_from = total_load) %>% 
  rename(below_liberty = "Below Liberty") %>% 
  # Calculate net loads for each reach
  mutate(
    upper = Outlet - Inlet,
    lower = below_liberty - Outlet,
    entire = below_liberty - Inlet
  ) %>% 
  select(-c(Inlet:below_liberty)) %>% 
  pivot_longer(
    cols = upper:entire,
    names_to = "reach",
    values_to = "net_load"
  ) %>% 
  filter(!is.na(net_load)) %>% 
  group_by(Analyte, reach) %>% 
  summarize(
    avg_net_load = signif(mean(net_load), 3),
    stdev_net_load = signif(sd(net_load), 3)  
  ) %>% 
  ungroup()

# Show a kable for each reach
  # Upper reach
  net_loads_summ %>% 
    filter(reach == "upper") %>% 
    select(-reach) %>% 
    kable(caption = "Net Load- Upper Reach (Stairsteps - Input)") %>% 
    kable_styling("striped")
  
  # Lower reach
  net_loads_summ %>% 
    filter(reach == "lower") %>% 
    select(-reach) %>% 
    kable(caption = "Net Load- Lower Reach (Below Liberty - Stairsteps)") %>% 
    kable_styling("striped")
  
  # Entire Bypass
  net_loads_summ %>% 
    filter(reach == "entire") %>% 
    select(-reach) %>% 
    kable(caption = "Net Load- Entire Bypass (Below Liberty - Input)") %>% 
    kable_styling("striped")
```
A few minor differences in Table 3-3 probably due to rounding differences. 

***

Calculate average export of uMeHg to the Delta from the entire Yolo Bypass
```{r avg export of uMeHg}
mehg_export_entire <- total_loads %>% 
  filter(
    Analyte == "MeHg- total",
    LocType == "Below Liberty"
  )

# Calculate average export
mehg_export_entire_avg <- signif(mean(mehg_export_entire$total_load), 3)

# Calculate std deviation of export
mehg_export_entire_stdev <- signif(sd(mehg_export_entire$total_load), 3)
```
The lower reach added an additional 3.6 ± 12.2 g/day to the overall average export to the Delta of `r mehg_export_entire_avg` ± `r mehg_export_entire_stdev` g/day of uMeHg.


